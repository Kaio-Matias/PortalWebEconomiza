@page
@model PortalWebEconomiza.Pages.IndexModel
@{
    ViewData["Title"] = "Consulta de Preços";
}

<div class="text-center">
    <h1 class="display-4">Consulta de Preços Sefaz</h1>
    <p>Utilize os filtros abaixo para pesquisar os preços de produtos.</p>
</div>

<form method="post" id="consultaForm">
    
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4>Filtros da API</h4>
        </div>
        <div class="card-body">
            
            <fieldset class="filter-fieldset">
                <legend class="filter-legend">Filtros de Produto</legend>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="Filtros.Descricao" class="form-label"></label>
                        <input asp-for="Filtros.Descricao" class="form-control" placeholder="Arroz, Feijão (separados por vírgula)" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Filtros.Gtin" class="form-label">GTIN (Código de Barras)</label>
                        <input asp-for="Filtros.Gtin" class="form-control" placeholder="Ex: 789..., 788... (separados por vírgula)" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Filtros.Gpc" class="form-label">GPC</label>
                        <input asp-for="Filtros.Gpc" class="form-control" placeholder="Ex: 50000000" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Filtros.Ncm" class="form-label">NCM</label>
                        <input asp-for="Filtros.Ncm" class="form-control" placeholder="Ex: 22021000" />
                    </div>
                </div>
            </fieldset>

            <fieldset class="filter-fieldset mt-3">
                <legend class="filter-legend">Filtros de Estabelecimento e Período</legend>
                <div class="row g-3">
                    <div class="col-md-5">
                        <label asp-for="Filtros.Cnpj" class="form-label">CNPJ do Estabelecimento</label>
                        <input asp-for="Filtros.Cnpj" class="form-control" placeholder="Ex: 00000000000100" />
                    </div>
                    <div class="col-md-4">
                        <label asp-for="Filtros.CodigosIBGE" class="form-label"></label>
                        <select asp-for="Filtros.CodigosIBGE" asp-items="Model.MunicipiosOptions" class="form-control" multiple size="5">
                            <option value="">-- Todos os Municípios --</option>
                        </select>
                        <div class="mt-2">
                            <button type="button" id="btnSelecionarTodosMunicipios" class="btn btn-link btn-sm p-0">Selecionar Todos</button>
                            |
                            <button type="button" id="btnLimparSelecaoMunicipios" class="btn btn-link btn-sm p-0">Limpar Seleção</button>
                        </div>
                        <small class="form-text text-muted">Use os botões ou segure Ctrl para selecionar múltiplos.</small>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Filtros.Dias" class="form-label"></label>
                        <input asp-for="Filtros.Dias" class="form-control" />
                        <span asp-validation-for="Filtros.Dias" class="text-danger"></span>
                    </div>
                </div>
            </fieldset>

        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-search"></i> Consultar Preços
            </button>
        </div>
    </div>
</form>

@if (Model.ResultadoPesquisa != null)
{
    <div class="card shadow-sm">
        <div class="card-header">
            <h4>Resultados da Pesquisa (@Model.ResultadoPesquisa.TotalRegistros registros encontrados)</h4>
        </div>
        <div class="card-body">
            @if (Model.ResultadoPesquisa.Conteudo.Any())
            {
                <fieldset class="filter-fieldset">
                    <legend class="filter-legend">Filtrar Resultados</legend>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterProduto" class="form-label">Filtrar por Produto</label>
                            <input type="text" id="filterProduto" class="form-control form-control-sm" placeholder="Digite o nome do produto..." />
                        </div>
                        <div class="col-md-3">
                            <label for="filterGtin" class="form-label">Filtrar por GTIN</label>
                            <input type="text" id="filterGtin" class="form-control form-control-sm" placeholder="Digite o GTIN..." />
                        </div>
                        <div class="col-md-3">
                            <label for="filterMunicipio" class="form-label">Filtrar por Município</label>
                            <input type="text" id="filterMunicipio" class="form-control form-control-sm" placeholder="Digite o município..." />
                        </div>
                        <div class="col-md-3">
                            <label for="filterDataVenda" class="form-label">Filtrar por Data da Venda</label>
                            <input type="date" id="filterDataVenda" class="form-control form-control-sm" />
                        </div>
                    </div>
                </fieldset>

                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm" id="resultsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Produto (Descrição Sefaz)</th>
                                <th>GTIN</th>
                                <th>Valor Venda (R$)</th>
                                <th>Data Venda</th>
                                <th>Estabelecimento (Nome Fantasia)</th>
                                <th>Município</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var registro in Model.ResultadoPesquisa.Conteudo)
                            {
                                <tr>
                                    <td>@registro.Produto?.DescricaoSefaz</td>
                                    <td>@registro.Produto?.Gtin</td>
                                    <td>@registro.Produto?.Venda?.ValorVenda.ToString("C2")</td>
                                    <td>@registro.Produto?.Venda?.DataVenda.ToString("dd/MM/yyyy")</td>
                                    <td>@registro.Estabelecimento?.NomeFantasia</td>
                                    <td>@registro.Estabelecimento?.Endereco?.Municipio</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning" role="alert">
                    Nenhum registro foi encontrado com os filtros informados.
                </div>
            }
        </div>
    </div>
}

<div id="loadingModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="spinner"></div>
        <p>Consultando, por favor aguarde...</p>
        <p>Isso pode levar alguns segundos.</p>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}